import "../css/cross.css"

const Cross = {
  data: "{\"crossword\":[[\"f\",\"a\",\"l\",\"s\",\"a\",\"r\",\"r\",\"e\",\"g\",\"l\",\"a\"],[\"o\",\"r\",\"i\",\"l\",\"l\",\"a\",\"r\",\"i\",\"a\",\"i\",\"s\"],[\"j\",\"a\",\"d\",\"i\",\"a\",\"r\",\"0\",\"r\",\"u\",\"l\",\"a\"],[\"a\",\"d\",\"0\",\"p\",\"r\",\"i\",\"v\",\"a\",\"d\",\"o\",\"0\"],[\"0\",\"o\",\"i\",\"0\",\"o\",\"d\",\"a\",\"0\",\"e\",\"0\",\"e\"],[\"i\",\"r\",\"0\",\"i\",\"z\",\"a\",\"r\",\"i\",\"a\",\"i\",\"s\"],[\"c\",\"a\",\"n\",\"t\",\"a\",\"d\",\"a\",\"0\",\"m\",\"0\",\"p\"],[\"o\",\"0\",\"o\",\"a\",\"0\",\"0\",\"l\",\"i\",\"u\",\"d\",\"a\"],[\"r\",\"a\",\"l\",\"l\",\"a\",\"r\",\"0\",\"o\",\"s\",\"0\",\"ñ\"],[\"0\",\"v\",\"i\",\"a\",\"0\",\"r\",\"u\",\"n\",\"0\",\"s\",\"o\"],[\"j\",\"e\",\"t\",\"0\",\"c\",\"0\",\"h\",\"0\",\"r\",\"o\",\"l\"]],\"definitions\":{\"hor\":{\"1\":\"<span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> <span class=\\\"abbr\\\" data-title=\\\"Andalucía\\\">And.</span> falsilla.\",\"2\":\"<span class=\\\"abbr\\\" data-title=\\\"verbal\\\">verb.</span> 2 persona plural condicional del verbo orillar.\",\"3\":\"<span class=\\\"abbr\\\" data-title=\\\"transitivo verbo&nbsp;transitivo\\\">tr.</span> <span class=\\\"abbr\\\" data-title=\\\"rural\\\">rur.</span> <span class=\\\"abbr\\\" data-title=\\\"Aragón\\\">Ar.</span> Cavar con la jada.  //  <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> <span class=\\\"abbr\\\" data-title=\\\"Asturias\\\">Ast.</span> y <span class=\\\"abbr\\\" data-title=\\\"Málaga\\\">Mál.</span> Lonja de contratación del pescado.\",\"4\":\"<span class=\\\"abbr\\\" data-title=\\\"preposición\\\">prep.</span> <span class=\\\"abbr\\\" data-title=\\\"desusado\\\">desus.</span> a.  //  <span class=\\\"abbr\\\" data-title=\\\"adjetivo\\\">adj.</span> <span class=\\\"abbr\\\" data-title=\\\"Canarias\\\">Can.</span> Muy contento, lleno de gozo.\",\"5\":\"<span class=\\\"abbr\\\" data-title=\\\"verbal\\\">verb.</span> 1 persona singular preterito perfecto del verbo oír.  //  <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> <span class=\\\"abbr\\\" data-title=\\\"teoría&nbsp;literaria\\\">T. lit.</span> Composición lírica en estrofas de tono elevado, que generalmente ensalza algo o a alguien.  //  <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> Sonido que representa la letra e.  //  <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> Sonido que representa la letra e.\",\"6\":\"<span class=\\\"abbr\\\" data-title=\\\"intransitivo verbo&nbsp;intransitivo\\\">intr.</span> Caminar de acá para allá.  //  <span class=\\\"abbr\\\" data-title=\\\"verbal\\\">verb.</span> 2 persona plural condicional del verbo izar.\",\"7\":\"<span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> <span class=\\\"abbr\\\" data-title=\\\"coloquial\\\">coloq.</span> <span class=\\\"abbr\\\" data-title=\\\"deportes\\\">Dep.</span> <span class=\\\"abbr\\\" data-title=\\\"España\\\">Esp.</span> Acción y efecto de cantar (‖ fallar ostensiblemente).  //  <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> En la numeración romana, mil.  //  <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> Sonido que representa la letra p.\",\"8\":\"<span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> <span class=\\\"abbr\\\" data-title=\\\"filosofía\\\">Fil.</span> En la lógica escolástica, letra que representa la proposición particular negativa.  //  <span class=\\\"abbr\\\" data-title=\\\"masculino nombre&nbsp;masculino\\\">m.</span> <span class=\\\"abbr\\\" data-title=\\\"Honduras\\\">Hond.</span> Juego infantil en el que un niño lanza una pelota al aire y, antes de que caiga, debe decir con rapidez un texto y hacer lo que le indica otro niño.  //  <span class=\\\"abbr\\\" data-title=\\\"adjetivo\\\">adj.</span> <span class=\\\"abbr\\\" data-title=\\\"desusado\\\">desus.</span> leudo. U. en <span class=\\\"abbr\\\" data-title=\\\"Andalucía\\\">And.</span> y Col.\",\"9\":\"<span class=\\\"abbr\\\" data-title=\\\"intransitivo verbo&nbsp;intransitivo\\\">intr.</span> <span class=\\\"abbr\\\" data-title=\\\"Salamanca\\\">Sal.</span> Hablar descaradamente.  //  <span class=\\\"abbr\\\" data-title=\\\"pronombre\\\">pron.</span> <span class=\\\"abbr\\\" data-title=\\\"personal\\\">person.</span> 2.ª <span class=\\\"abbr\\\" data-title=\\\"persona\\\">pers.</span> <span class=\\\"abbr\\\" data-title=\\\"masculino nombre&nbsp;masculino\\\">m.</span> y <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> <span class=\\\"abbr\\\" data-title=\\\"plural\\\">pl.</span> Forma que, en dativo o acusativo, designa a un grupo de personas entre las que se encuentra el destinatario del mensaje.  //  <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> Sonido que representa la letra ñ.\",\"10\":\"<span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> Entre los ascéticos, modo y orden de vida espiritual encaminada a la perfección de la virtud, y que se divide en tres estados: vía purgativa, iluminativa y unitiva.  //  <span class=\\\"abbr\\\" data-title=\\\"masculino nombre&nbsp;masculino\\\">m.</span> <span class=\\\"abbr\\\" data-title=\\\"Honduras\\\">Hond.</span> armadillo.  //  <span class=\\\"abbr\\\" data-title=\\\"adverbio adverbial\\\">adv.</span> U. para potenciar el significado del adjetivo o del sustantivo al que antecede, generalmente con sentido despectivo.\",\"11\":\"<span class=\\\"abbr\\\" data-title=\\\"masculino nombre&nbsp;masculino\\\">m.</span> reactor (‖ avión).  //  <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> Tercera letra del abecedario español, que representa, ante las vocales a, o, u, el fonema consonántico oclusivo velar sordo, p. ej., en cacao, y ante e, i, el fonema consonántico fricativo interdental sordo en áreas no seseantes, y algún alófono de /s/ en áreas de seseo, p. ej., en cecina.  //  <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> Octava letra del abecedario español, que en la lengua estándar actual no representa sonido alguno, si bien se aspira en determinadas voces de origen extranjero, como hámster o dírham, y en algunas zonas españolas y americanas como rasgo dialectal.  //  <span class=\\\"abbr\\\" data-title=\\\"masculino nombre&nbsp;masculino\\\">m.</span> Rolde o rollo.\"},\"ver\":{\"1\":\"<span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> focha.  //  <span class=\\\"abbr\\\" data-title=\\\"masculino nombre&nbsp;masculino\\\">m.</span> <span class=\\\"abbr\\\" data-title=\\\"medicina\\\">Med.</span> En la antigua cirugía, líquido seroso que rezuman ciertas úlceras malignas, sin hallarse en él los elementos del pus y principalmente sus glóbulos.  //  <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> Décima letra del abecedario español, que representa el fonema consonántico fricativo velar sordo, el cual, en zonas meridionales de España y amplias zonas de América, se relaja hasta hacerse aspirado.\",\"2\":\"<span class=\\\"abbr\\\" data-title=\\\"adjetivo\\\">adj.</span> Que ara. U. <span class=\\\"abbr\\\" data-title=\\\"terminación\\\">t.</span> <span class=\\\"abbr\\\" data-title=\\\"como\\\">c.</span> s.  //  <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> Animal vertebrado, ovíparo, de respiración pulmonar y sangre de temperatura constante, pico córneo, cuerpo cubierto de plumas, con dos patas y dos alas aptas por lo común para el vuelo, y que, en estado embrionario, tiene amnios y alantoides. U. <span class=\\\"abbr\\\" data-title=\\\"terminación\\\">t.</span> en <span class=\\\"abbr\\\" data-title=\\\"plural\\\">pl.</span> como taxón.\",\"3\":\"<span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> <span class=\\\"abbr\\\" data-title=\\\"desusado\\\">desus.</span> Pleito judicial.  //  <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> Sonido que representa la letra i.  //  <span class=\\\"abbr\\\" data-title=\\\"masculino nombre&nbsp;masculino\\\">m.</span> <span class=\\\"abbr\\\" data-title=\\\"desusado\\\">desus.</span> flete (‖ precio del alquiler de una nave).\",\"4\":\"<span class=\\\"abbr\\\" data-title=\\\"masculino nombre&nbsp;masculino\\\">m.</span> Calzoncillo ajustado que cubre el cuerpo desde debajo de la cintura hasta las ingles.  //  <span class=\\\"abbr\\\" data-title=\\\"adjetivo\\\">adj.</span> italiano. U. <span class=\\\"abbr\\\" data-title=\\\"terminación\\\">t.</span> <span class=\\\"abbr\\\" data-title=\\\"como\\\">c.</span> <span class=\\\"abbr\\\" data-title=\\\"sustantivo\\\">s.</span> U. <span class=\\\"abbr\\\" data-title=\\\"masculino nombre&nbsp;masculino\\\">m.</span> en <span class=\\\"abbr\\\" data-title=\\\"lenguaje\\\">leng.</span> poét.\",\"5\":\"<span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> <span class=\\\"abbr\\\" data-title=\\\"desusado\\\">desus.</span> novia (‖ mujer que va a casarse).  //  <span class=\\\"abbr\\\" data-title=\\\"preposición\\\">prep.</span> para.  //  <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> Sonido que representa la letra c cuando va seguida de e o i en la pronunciación no seseante.\",\"6\":\"<span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> <span class=\\\"abbr\\\" data-title=\\\"poco&nbsp;usado\\\">p. us.</span> Cualidad de raro.  //  <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> Dígrafo que representa el fonema vibrante múltiple en posición intervocálica, como en carro, arrabal.\",\"7\":\"<span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> Dígrafo que representa el fonema vibrante múltiple en posición intervocálica, como en carro, arrabal.  //  <span class=\\\"abbr\\\" data-title=\\\"masculino nombre&nbsp;masculino\\\">m.</span> Cada uno de los dos largueros que llevan en los costados las andas de las imágenes.  //  <span class=\\\"abbr\\\" data-title=\\\"interjección interjectivo\\\">interj.</span> U. para denotar desilusión o desdén.\",\"8\":\"<span class=\\\"abbr\\\" data-title=\\\"masculino nombre&nbsp;masculino\\\">m.</span> <span class=\\\"abbr\\\" data-title=\\\"Argentina\\\">Arg.</span> Animal carnívoro de la familia de los mustélidos, que alcanza poco más de un metro de longitud, con patas relativamente largas y pelaje corto, liso y de color pardo oscuro, que se alimenta de pequeños mamíferos y de miel.  //  <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> Sonido que representa la letra i.  //  <span class=\\\"abbr\\\" data-title=\\\"masculino nombre&nbsp;masculino\\\">m.</span> <span class=\\\"abbr\\\" data-title=\\\"física\\\">Fís.</span> y <span class=\\\"abbr\\\" data-title=\\\"química\\\">Quím.</span> Átomo o agrupación de átomos que por pérdida o ganancia de uno o más electrones adquiere carga eléctrica.\",\"9\":\"<span class=\\\"abbr\\\" data-title=\\\"masculino nombre&nbsp;masculino\\\">m.</span> <span class=\\\"abbr\\\" data-title=\\\"coloquial\\\">coloq.</span> Fiesta, regocijo, comida y bebida abundantes.  //  <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> Alguno de los sonidos que representa la letra r.\",\"10\":\"<span class=\\\"abbr\\\" data-title=\\\"masculino nombre&nbsp;masculino\\\">m.</span> lila (‖ arbusto).  //  <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> En la numeración romana, uno.  //  <span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> Sonido que representa la letra d.  //  <span class=\\\"abbr\\\" data-title=\\\"adverbio adverbial\\\">adv.</span> U. para potenciar el significado del adjetivo o del sustantivo al que antecede, generalmente con sentido despectivo.\",\"11\":\"<span class=\\\"abbr\\\" data-title=\\\"femenino nombre&nbsp;femenino\\\">f.</span> <span class=\\\"abbr\\\" data-title=\\\"Granada\\\">Gran.</span> acebo.  //  <span class=\\\"abbr\\\" data-title=\\\"masculino nombre&nbsp;masculino\\\">m.</span> Lengua romance que se habla en España, gran parte de América, Filipinas, Guinea Ecuatorial y otros lugares del mundo.\"}},\"file\":\"crucigrama_espana_1666746404\",\"title\":\"Crucigrama España\"}",

  active_links: function () {

    document.getElementById("go-up").addEventListener("click", function (e) {
      let board = document.getElementById("crossword-board")
      window.scrollTo({ top: window.scrollY + (board.getBoundingClientRect().y - 50), behavoir: 'smooth' })
    })

    for (elem of document.getElementsByClassName("num_link")) {
      elem.addEventListener("click", function (e) {
        id = e.currentTarget.getAttribute("id")
        def = document.getElementById(id.replace("num", "def"))
        window.scrollTo({ top: window.scrollY + def.getBoundingClientRect().y, behavior: 'smooth' })
      })
    }

    for (elem of document.getElementsByClassName("cell-input")) {
      elem.addEventListener("click", function (e) {
        e.currentTarget.select()
      })
      elem.addEventListener("blur", function (e) {
        arr_id = e.currentTarget.getAttribute("id").split("-");
        value = e.currentTarget.value;
        if (Cross.add_value_to_crossword(arr_id[1], arr_id[2], value) && Cross.is_full_board()) {
          if (check_end()) {
            Cross.delete_cookie_board(this.datafile);
            Cross.set_resp("Has completado el crucigrama");
          } else {
            Cross.set_resp("Hay palabras incorrectas");
          }
        }
      })
    }

    document.getElementById("btn-correct").addEventListener("click", function (e) {
      for (i = 0; i < board.length; i++) {
        for (j = 0; j < board[i].length; j++) {
          cell = board[i][j];
          if (cell != "" && !/\*/.test(cell) && cell != crossword[i][j]) {
            board[i][j] = "*" + cell;
          }
        }
      }
      Cross.load_board(board);
      Cross.active_links();

      Cross.set_resp("Hay tienes una ayuda");
    })
  },

  add_value_to_crossword: function (id_line, id_col, value) {

    input = document.getElementById("c-" + id_line + '-' + id_col);
    prev_val = document.getElementById("c-" + id_line + '-' + id_col).getAttribute("value");

    if (/[a-zñ]/i.test(value) && prev_val != value) {
      board[id_line][id_col] = value.toUpperCase();
      Cross.set_cookie_board(JSON.parse(Cross.data).file, board);
      input.value = value.toUpperCase();
      input.classList.remove("corrected");
      Cross.set_resp("Has colocado una letra");
      return true;
    } else {
      if (value == "") {
        input.classList.remove("corrected");
      } 
      this.set_resp();
      input.value = "";
      return false
    }
  },

  check_end: function () {
    end = true;
    for (i = 0; i < board.length; i++) {
      for (j = 0; j < board[i].length; j++) {
        if (board[i][j] != crossword[i][j]) { end = false; }
      }
    }
    return end;
  },

  delete_cookie_board: function (name) {
    document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;Samesite=Lax;";
  },

  get_blank_crossword: function () {
    blank = []
    for (x = 0; x < 11; x++) {
      aux = [];
      for (y = 0; y < 11; y++) { aux.push(""); }
      blank.push(aux);
    }
    return blank;
  },

  load_board: function (board) {
    if (typeof board == "undefined") {
      board = get_blank_crossword()
    }

    html = ['<div class="board">']

    html.push('<div class="line">')
    for (num = 0; num <= board.length; num++) {
      if (num == 0) {
        html.push('<div class="cell blank"></div>');
      } else {
        html.push('<div id="num-ver-' + num + '" class="cell numv num_link" phx-hook="CrosswordNumToDef"><span>' + num + '</span></div>')
      }
    }
    html.push("</div>")

    for (i = 0; i < board.length; i++) {
      html.push('<div class="line">')
      html.push('<div  id="num-hor-' + (i + 1) + '" class="cell numh num_link" phx-hook="CrosswordNumToDef"><span>' + (i + 1) + '</span></div>')
      for (j = 0; j < board[i].length; j++) {
        var id_i = "c-" + i + "-" + j
        cell = board[i][j]
        html.push('<div class="cell" id="cell-' + i + '-' + j + '">')
        if (/\-/.test(cell)) {
          html.push('<input id="' + id_i + '" class="cell-input" maxlength="1" phx-blur="crossword-blur" value="">')
        } else if (/\*/.test(cell)) {
          html.push('<input id="' + id_i + '" class="cell-input corrected" maxlength="1" phx-blur="crossword-blur" value="' + cell.replace("*", "") + '">')
        } else if (cell === "0") {
          html.push('<span class="block">' + cell + '</span>')
        } else {
          html.push('<input id="' + id_i + '" class="cell-input" maxlength="1" phx-blur="crossword-blur" value="' + cell + '">')
        }
        html.push("</div>")
      }
      html.push("</div>")
    }
    html.push('</div>')

    document.getElementById("crossword-board").innerHTML = html.join("")
  },

  load_defs: function (definitions) {
    html = ['<div class="definitions">']
    for (ori in definitions) {
      html.push('<div class="orientacion">')
      html.push('<h3>' + (ori == "hor" ? "Horizontal" : "Vertical") + '</h3>')
      html.push('<p>')
      for (num in definitions[ori]) {
        html.push('<span id="def-' + ori + '-' + num + '">' + num + '. - </span><span>' + definitions[ori][num] + '</span><br>')
        // html.push('<span id="def-' + ori + '-' + num + '">' + num + '. - </span><span>' + definitions[ori][num].join(" // ") + '</span><br>')
      }
      html.push('</p></div>')
    }
    html.push('</div>')
    document.getElementById("crossword-defs").innerHTML = html.join("")
  },

  init_crossword: function () {
    data = JSON.parse(this.data);
    crossword = data.crossword.map(line => {
      return line.map(letter => { return letter.toUpperCase(); });
    });

    prev = this.get_cookie_board(data.file);
    board = false;
    if (prev) {
      if (confirm("Se ha detectado una partida previa. Deseas continuarla?")) {
        board = prev;
      } else {
        this.delete_cookie_board(data.file);
      }
    }
    if (!board) {
      board = crossword.map(line => {
        return line.map(letter => { return letter == 0 ? letter : ""; });
      });
    }

    this.load_board(board);
    this.load_defs(data.definitions);

    document.getElementById("crossword-title").innerHTML = data.title;
    this.active_links();
    this.set_resp("Crucigrama preparado");
  },

  is_full_board: function () {
    for (line of board) {
      for (letra of line) {
        if (letra == "" || letra == "-1") { return false; }
      }
    }
    return true;
  },

  get_cookie_board: function (name) {
    for (cookie of document.cookie.split("; ")) {
      a_cookie = cookie.split("=");
      if (a_cookie[0] == name && a_cookie[1] != "") {
        return JSON.parse(a_cookie[1]);
      }
    }
    return false;
  },

  set_cookie_board: function (cname, board, exdays = 1) {
    board_str = JSON.stringify(board);
    const d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));

    document.cookie = cname + "=" + board_str + ";expires=" + d.toUTCString() + ";path=/;Samesite=Lax;";
  },

  set_resp: function (resp) {
    text = "";
    if (typeof resp != "undefined" && resp != "") {
      text = "<h3>" + resp + "</h3>";
    }
    document.getElementById("crossword-resp").innerHTML = text;
  },
}

window.onload = function () {
  Cross.init_crossword();
}
